<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glioseg</title>
    <link rel="stylesheet" href="static/css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css"
    />
  </head>
  <body class="bg-dark-subtle">
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-semibold" href="#">
          <i class="bi bi-activity me-2"></i>Glioma AI Workstation
        </a>
        <div class="navbar-nav me-auto">
          <button
            class="btn btn-outline-light btn-sm mx-1"
            id="show-register-btn"
          >
            <i class="bi bi-person-plus me-1"></i>Register Patient
          </button>
          <button
            class="btn btn-outline-light btn-sm mx-1"
            id="show-search-btn"
          >
            <i class="bi bi-search me-1"></i>Search Patients
          </button>
          <button
            class="btn btn-outline-light btn-sm mx-1"
            id="show-patients-btn"
          >
            <i class="bi bi-people me-1"></i>All Patients
          </button>
        </div>
        <div class="d-flex align-items-center">
          <span class="text-light small me-3">Radiology Dept.</span>
          <span
            class="badge bg-success-subtle text-success-emphasis border border-success-subtle"
          >
            Online
          </span>
        </div>
      </div>
    </nav>

    <!-- Patient Registration Modal -->
    <div class="modal fade" id="registerModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-plus me-2"></i>Register New Patient
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="register-form">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="reg-patient-id" class="form-label"
                    >Patient ID *</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="reg-patient-id"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="reg-name" class="form-label">Full Name *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="reg-name"
                    required
                  />
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="reg-age" class="form-label">Age</label>
                  <input
                    type="number"
                    class="form-control"
                    id="reg-age"
                    min="0"
                    max="150"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="reg-sex" class="form-label">Sex</label>
                  <select class="form-select" id="reg-sex">
                    <option value="">Select</option>
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="reg-dob" class="form-label">Date of Birth</label>
                  <input type="date" class="form-control" id="reg-dob" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="reg-email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="reg-email" />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="reg-phone" class="form-label">Phone</label>
                  <input type="tel" class="form-control" id="reg-phone" />
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="reg-mrn" class="form-label"
                    >Medical Record Number</label
                  >
                  <input type="text" class="form-control" id="reg-mrn" />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="reg-physician" class="form-label"
                    >Attending Physician</label
                  >
                  <input type="text" class="form-control" id="reg-physician" />
                </div>
              </div>
              <div class="mb-3">
                <label for="reg-notes" class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="reg-notes"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="register-submit-btn"
            >
              Register Patient
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-search me-2"></i>Search Patients
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-8">
                <input
                  type="text"
                  class="form-control"
                  id="search-input"
                  placeholder="Enter search term..."
                />
              </div>
              <div class="col-md-4">
                <select class="form-select" id="search-type">
                  <option value="all">All Fields</option>
                  <option value="patient_id">Patient ID</option>
                  <option value="name">Name</option>
                  <option value="email">Email</option>
                  <option value="mrn">Medical Record Number</option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col">
                <button class="btn btn-primary" id="search-submit-btn">
                  <i class="bi bi-search me-1"></i>Search
                </button>
              </div>
            </div>
            <div id="search-results"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Patients List Modal -->
    <div class="modal fade" id="patientsModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-people me-2"></i>All Patients
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="patients-list"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Email Options Modal -->
    <div class="modal fade" id="emailModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-envelope me-2"></i>Send Results via Email
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="email-form">
              <div class="mb-3">
                <label for="email-recipient" class="form-label"
                  >Recipient Email</label
                >
                <input
                  type="email"
                  class="form-control"
                  id="email-recipient"
                  placeholder="Leave blank to use patient email"
                />
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="include-report"
                    checked
                  />
                  <label class="form-check-label" for="include-report">
                    Include PDF Report
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="include-mask"
                    checked
                  />
                  <label class="form-check-label" for="include-mask">
                    Include Segmentation Mask
                  </label>
                </div>
              </div>
              <div class="mb-3">
                <label for="email-message" class="form-label"
                  >Custom Message</label
                >
                <textarea
                  class="form-control"
                  id="email-message"
                  rows="3"
                  placeholder="Optional custom message..."
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="send-email-btn">
              Send Email
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="container-fluid py-3">
      <div class="row g-3">
        <!-- Left Panel: Upload & Patient Info -->
        <div class="col-12 col-lg-3">
          <!-- Patient Selection -->
          <div class="card shadow-sm mb-3 border-0 rounded-3">
            <div class="card-header bg-body-secondary fw-semibold">
              <i class="bi bi-person me-2"></i>Patient Selection
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label
                  for="current-patient-id"
                  class="form-label small fw-semibold"
                  >Current Patient ID</label
                >
                <div class="input-group input-group-sm">
                  <input
                    type="text"
                    class="form-control"
                    id="current-patient-id"
                    placeholder="Enter or search patient ID"
                  />
                  <button
                    class="btn btn-outline-secondary"
                    type="button"
                    id="load-patient-btn"
                  >
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </div>
              </div>
              <div id="patient-info" class="d-none">
                <div class="small border-top pt-2">
                  <div class="mb-1 d-flex justify-content-between">
                    <span class="text-muted">Name</span>
                    <span id="patient-name-label" class="fw-semibold">-</span>
                  </div>
                  <div class="mb-1 d-flex justify-content-between">
                    <span class="text-muted">Age</span>
                    <span id="patient-age-label">-</span>
                  </div>
                  <div class="mb-1 d-flex justify-content-between">
                    <span class="text-muted">Sex</span>
                    <span id="patient-sex-label">-</span>
                  </div>
                  <div class="mb-1 d-flex justify-content-between">
                    <span class="text-muted">Email</span>
                    <span
                      id="patient-email-label"
                      class="small text-truncate"
                      style="max-width: 120px"
                      >-</span
                    >
                  </div>
                  <div class="mb-1 d-flex justify-content-between">
                    <span class="text-muted">Scans</span>
                    <span id="patient-scans-count">0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Upload Section -->
          <div class="card shadow-sm border-0 rounded-3">
            <div class="card-header bg-body-secondary fw-semibold">
              <i class="bi bi-upload me-2"></i>Upload MRI Scans
            </div>
            <div class="card-body">
              <!-- Upload Type Selection -->
              <div class="mb-3">
                <label class="form-label small fw-semibold"
                  >Upload Method</label
                >
                <div class="btn-group btn-group-sm w-100" role="group">
                  <input
                    type="radio"
                    class="btn-check"
                    name="upload-type"
                    id="upload-individual"
                    checked
                  />
                  <label class="btn btn-outline-primary" for="upload-individual"
                    >Individual</label
                  >

                  <input
                    type="radio"
                    class="btn-check"
                    name="upload-type"
                    id="upload-zip"
                  />
                  <label class="btn btn-outline-primary" for="upload-zip"
                    >Zip File</label
                  >
                </div>
              </div>

              <!-- Individual File Upload -->
              <div id="individual-upload-section">
                <form id="upload-individual-form">
                  <div class="mb-2">
                    <label for="t1c_file" class="form-label small fw-semibold"
                      >T1c (Post-contrast)</label
                    >
                    <input
                      class="form-control form-control-sm"
                      type="file"
                      id="t1c_file"
                      accept=".nii,.nii.gz"
                    />
                  </div>
                  <div class="mb-2">
                    <label for="t1n_file" class="form-label small fw-semibold"
                      >T1n (Native)</label
                    >
                    <input
                      class="form-control form-control-sm"
                      type="file"
                      id="t1n_file"
                      accept=".nii,.nii.gz"
                    />
                  </div>
                  <div class="mb-2">
                    <label for="t2f_file" class="form-label small fw-semibold"
                      >T2f (FLAIR)</label
                    >
                    <input
                      class="form-control form-control-sm"
                      type="file"
                      id="t2f_file"
                      accept=".nii,.nii.gz"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="t2w_file" class="form-label small fw-semibold"
                      >T2w</label
                    >
                    <input
                      class="form-control form-control-sm"
                      type="file"
                      id="t2w_file"
                      accept=".nii,.nii.gz"
                    />
                  </div>

                  <div class="d-grid">
                    <button
                      type="submit"
                      class="btn btn-primary btn-sm"
                      id="upload-individual-btn"
                    >
                      <i class="bi bi-cloud-upload me-1"></i>Upload Files
                    </button>
                  </div>
                </form>
              </div>

              <!-- Zip File Upload -->
              <div id="zip-upload-section" class="d-none">
                <form id="upload-zip-form">
                  <div class="mb-3">
                    <label for="zip_file" class="form-label small fw-semibold"
                      >ZIP File</label
                    >
                    <input
                      class="form-control form-control-sm"
                      type="file"
                      id="zip_file"
                      accept=".zip"
                    />
                    <div class="form-text small">
                      ZIP should contain: t1c.nii.gz, t1n.nii.gz, t2f.nii.gz,
                      t2w.nii.gz
                    </div>
                  </div>

                  <div class="d-grid">
                    <button
                      type="submit"
                      class="btn btn-primary btn-sm"
                      id="upload-zip-btn"
                    >
                      <i class="bi bi-archive me-1"></i>Upload ZIP
                    </button>
                  </div>
                </form>
              </div>

              <!-- Scan Selection for Segmentation -->
              <div
                id="scan-selection-section"
                class="d-none mt-3 border-top pt-3"
              >
                <div class="mb-2">
                  <label for="scan-select" class="form-label small fw-semibold"
                    >Select Scan for Segmentation</label
                  >
                  <select class="form-select form-select-sm" id="scan-select">
                    <option value="">Choose a scan...</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label
                    for="radiologist-notes"
                    class="form-label small fw-semibold"
                    >Radiologist Notes (Optional)</label
                  >
                  <textarea
                    class="form-control form-control-sm"
                    id="radiologist-notes"
                    rows="2"
                    placeholder="Enter any notes or observations..."
                  ></textarea>
                </div>
                <div class="d-grid">
                  <button
                    type="button"
                    class="btn btn-success btn-sm"
                    id="run-segmentation-btn"
                  >
                    <i class="bi bi-cpu me-1"></i>Run Segmentation
                  </button>
                </div>
              </div>

              <!-- Status -->
              <div class="mt-3">
                <div class="small text-muted">Status</div>
                <div class="d-flex align-items-center mt-1">
                  <span
                    id="status-badge"
                    class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle"
                  >
                    Idle
                  </span>
                  <div
                    class="spinner-border spinner-border-sm ms-2 d-none"
                    id="status-spinner"
                    role="status"
                  >
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Center Panel: Image Viewer -->
        <div class="col-12 col-lg-6">
          <div class="card shadow-sm border-0 rounded-3 h-100">
            <div
              class="card-header bg-body-secondary fw-semibold d-flex justify-content-between align-items-center"
            >
              <span><i class="bi bi-image me-2"></i>Slice Viewer</span>
              <span
                class="badge bg-primary-subtle text-primary-emphasis small"
                id="slice-label"
              >
                Slice 0 / 0
              </span>
            </div>
            <div class="card-body d-flex flex-column">
              <!-- Viewer area -->
              <div
                class="viewer-container flex-grow-1 mb-3 d-flex justify-content-center align-items-center"
              >
                <!-- Background MRI -->
                <img
                  id="mri-image"
                  src=""
                  alt="MRI slice"
                  class="img-fluid d-none rounded-3 shadow-sm"
                />
                <!-- Overlay segmentation -->
                <img
                  id="segmentation-overlay"
                  src=""
                  alt="Segmentation overlay"
                  class="img-fluid d-none rounded-3 position-absolute overlay-image"
                />
                <div id="placeholder-text" class="text-muted text-center">
                  No image loaded yet.<br />
                  <span class="small"
                    >Upload a study and run segmentation to view slices.</span
                  >
                </div>
              </div>

              <!-- Controls -->
              <div class="row gy-2">
                <div class="col-12">
                  <label class="form-label small fw-semibold mb-1">
                    Slice
                  </label>
                  <input
                    type="range"
                    class="form-range"
                    min="0"
                    max="0"
                    value="0"
                    id="slice-slider"
                    disabled
                  />
                </div>

                <div class="col-12 col-md-5">
                  <div class="form-check form-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="toggle-overlay"
                      checked
                    />
                    <label class="form-check-label small" for="toggle-overlay">
                      Show segmentation overlay
                    </label>
                  </div>
                </div>

                <div class="col-12 col-md-7">
                  <label class="form-label small fw-semibold mb-1">
                    Overlay opacity
                  </label>
                  <input
                    type="range"
                    class="form-range"
                    min="0"
                    max="100"
                    value="70"
                    id="overlay-opacity"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel: Model Output & Notes -->
        <div class="col-12 col-lg-3">
          <div class="card shadow-sm mb-3 border-0 rounded-3">
            <div class="card-header bg-body-secondary fw-semibold">
              <i class="bi bi-bar-chart-line me-2"></i>Segmentation Summary
            </div>
            <div class="card-body small">
              <div class="mb-2 d-flex justify-content-between">
                <span class="text-muted">Tumor volume</span>
                <span class="fw-semibold" id="tumor-volume-label">-</span>
              </div>
              <div class="mb-2 d-flex justify-content-between">
                <span class="text-muted">Model confidence</span>
                <span id="confidence-label">-</span>
              </div>
              <div class="mb-3 d-flex justify-content-between">
                <span class="text-muted">Total slices</span>
                <span id="num-slices-label">-</span>
              </div>

              <div class="border-top pt-3">
                <label class="form-label small fw-semibold">
                  Current Radiologist notes
                </label>
                <textarea
                  class="form-control form-control-sm"
                  rows="4"
                  id="current-radiologist-notes"
                  readonly
                  placeholder="Notes will appear here after segmentation..."
                ></textarea>
              </div>
            </div>
          </div>

          <div class="card shadow-sm border-0 rounded-3">
            <div class="card-header bg-body-secondary fw-semibold">
              <i class="bi bi-download me-2"></i>Exports & Actions
            </div>
            <div class="card-body small">
              <p class="text-muted mb-2">
                Export results or send to patient via email.
              </p>
              <div class="d-grid gap-2">
                <button
                  class="btn btn-outline-primary btn-sm"
                  type="button"
                  disabled
                  id="download-mask-btn"
                >
                  <i class="bi bi-cloud-arrow-down me-1"></i>Download Mask
                </button>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  type="button"
                  disabled
                  id="download-report-btn"
                >
                  <i class="bi bi-file-earmark-text me-1"></i>Download Report
                </button>
                <button
                  class="btn btn-outline-success btn-sm"
                  type="button"
                  disabled
                  id="email-btn"
                >
                  <i class="bi bi-envelope me-1"></i>Email Results
                </button>
              </div>

              <div class="border-top pt-3 mt-3">
                <label class="form-label small fw-semibold">
                  Patient Results History
                </label>
                <div id="results-history" class="small">
                  <div class="text-muted">No results yet</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <script src="static/js/script.js"></script>
  </body>
</html>
